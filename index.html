<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASI - Proposal Tool Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #1a2a6c; --bg: #f3f4f6; --success: #27ae60; --share: #3b82f6; --copy: #8b5cf6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        
        .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section-label { font-size: 10px; font-weight: 800; color: #777; display: block; margin-top: 12px; margin-bottom: 4px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box;}
        
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; width: 100%; }
        .btn { flex: 1 1 auto; padding: 12px 15px; border: 1.5px solid var(--primary); background: #fff; cursor: pointer; font-weight: bold; border-radius: 6px; font-size: 12px; white-space: nowrap; text-align: center; }
        .btn.active { background: var(--primary); color: #fff; }
        
        .dynamic-row { background: #fafafa; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #eee; }
        .row-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }

        /* PREVIEW AREA (What you see on mobile) */
        .preview-scroll-container { width: 100%; overflow-x: auto; background: #ddd; padding: 10px; border-radius: 8px; box-sizing: border-box; }
        
        /* THE ACTUAL PROPOSAL UI (Applied to both preview and hidden capture) */
        .proposal-theme { 
            width: 800px; /* Fixed width for consistent professional layout */
            background: #fff; 
            padding: 40px; 
            box-sizing: border-box;
            color: #000;
        }
        .info-box { border: 1px solid #000; padding: 15px; margin-bottom: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; }
        .info-label { font-weight: bold; }
        .line-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .line-table th { text-align: center; border-bottom: 2px solid #000; padding: 10px 5px; font-size: 11px; text-transform: uppercase; }
        .line-table td { padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 13px; text-align: center; }
        .line-table th:first-child, .line-table td:first-child { text-align: left; padding-left: 5px; width: 35%; }
        .grand-total { font-size: 28px; font-weight: 900; margin-top: 5px; }

        /* HIDDEN CAPTURE DIV (Prevents mobile cutoffs) */
        #hidden-capture-wrapper { position: absolute; top: -9999px; left: -9999px; width: 800px; }

        .action-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; }
        .action-btn { border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .bg-success { background: var(--success); }
        .bg-share { background: var(--share); }
        .bg-copy { background: var(--copy); }
        .hide-in-screenshot { background: #eef2ff; border: 1px dashed #7c3aed; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 style="margin:0; color:var(--primary);">ASI Proposal Configurator</h2>
        <div class="hide-in-screenshot">
            <span class="section-label">1. Company Logo</span>
            <input type="file" id="logo-upload" accept="image/*" onchange="handleLogo(this)">
        </div>
        <div class="config-grid">
            <div><span class="section-label">2. Region</span><select id="region" onchange="applyDefaultSetup(); update();"><option value="INDIA" selected>INDIA (INR)</option><option value="AMER">AMER (USD)</option><option value="ROW">ROW (USD)</option></select></div>
            <div><span class="section-label">3. Master Cycle</span><div class="btn-group"><button class="btn active" id="c-monthly" onclick="setSub('monthly')">Monthly</button><button class="btn" id="c-quarterly" onclick="setSub('quarterly')">Quarterly</button><button class="btn" id="c-half-yearly" onclick="setSub('half-yearly')">Half-Yearly</button><button class="btn" id="c-yearly" onclick="setSub('yearly')">Yearly</button></div></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
             <div><span class="section-label">4. Rooms</span><input type="number" id="rooms" value="50" oninput="update()"></div>
             <div><span class="section-label">5. Plan Type</span><div class="btn-group"><button class="btn active" id="p-starter" onclick="setPlan('starter')">Starter</button><button class="btn" id="p-professional" onclick="setPlan('professional')">Professional</button></div></div>
        </div>
        <div style="background: #fdf2f2; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid var(--primary);">
            <div class="config-grid">
                <div><label class="section-label">Core Discount %</label><input type="number" id="soft-disc" value="0" oninput="update()"></div>
                <div><label class="section-label">Setup Fee</label><input type="number" id="setup-fee" value="5000" oninput="update()"></div>
            </div>
        </div>
        <span class="section-label">6. Add-ons</span><div id="addon-list"></div><button onclick="addRow()" style="margin-top:10px; cursor:pointer; padding: 12px; width: 100%; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold;">+ Add Line Item</button>
        <span class="section-label">7. Client Details</span><div class="config-grid"><input type="text" id="in-hotel" placeholder="Hotel Name" oninput="update()"><input type="text" id="in-cust" placeholder="Client Name" oninput="update()"><input type="text" id="in-email" placeholder="Email ID" oninput="update()"><input type="text" id="in-phone" placeholder="Phone" oninput="update()"><input type="text" id="in-sales" placeholder="Sales Person" oninput="update()"><input type="text" id="in-date" placeholder="Date" oninput="update()"></div>
        <textarea id="in-terms" rows="3" oninput="update()" style="margin-top:15px;" placeholder="Terms..."></textarea>
    </div>

    <div style="text-align: center; color: #999; font-size: 11px; font-weight: bold; text-transform: uppercase;">Preview Area</div>
    <div class="preview-scroll-container">
        <div id="proposal-preview" class="proposal-theme">
            </div>
    </div>

    <div id="hidden-capture-wrapper">
        <div id="proposal-capture" class="proposal-theme">
            </div>
    </div>

    <div class="action-buttons">
        <button class="action-btn bg-success" onclick="exportProposal('download')">Download PNG</button>
        <button class="action-btn bg-copy" onclick="exportProposal('copy')">Copy to Clipboard</button>
        <button class="action-btn bg-share" onclick="exportProposal('share')">Share</button>
    </div>
</div>

<script>
    const rates = {"AMER": [{min:1,max:15,starter:140,professional:185},{min:16,max:25,starter:165,professional:220},{min:26,max:35,starter:175,professional:235},{min:36,max:50,starter:185,professional:260},{min:51,max:75,starter:215,professional:295},{min:76,max:100,starter:240,professional:320},{min:101,max:125,starter:260,professional:335},{min:126,max:150,starter:280,professional:360},{min:151,max:200,starter:300,professional:380},{min:201,max:250,starter:335,professional:415},{min:251,max:300,starter:385,professional:480},{min:301,max:350,starter:435,professional:530},{min:351,max:400,starter:510,professional:605},{min:401,max:450,starter:560,professional:680},{min:451,max:9999,starter:610,professional:755}],"INDIA": [{min:1,max:15,starter:2000,professional:3500},{min:16,max:25,starter:2750,professional:4500},{min:26,max:35,starter:3500,professional:5500},{min:36,max:50,starter:4250,professional:6500},{min:51,max:75,starter:5000,professional:7500},{min:76,max:100,starter:5750,professional:8500},{min:101,max:125,starter:6750,professional:9750},{min:126,max:150,starter:7750,professional:11250},{min:151,max:200,starter:8750,professional:13750},{min:201,max:9999,starter:10000,professional:15250}],"ROW": [{min:1,max:15,starter:98,professional:130},{min:16,max:25,starter:115,professional:154},{min:26,max:35,starter:122,professional:164},{min:36,max:50,starter:130,professional:182},{min:51,max:75,starter:150,professional:206},{min:76,max:100,starter:168,professional:224},{min:101,max:125,starter:182,professional:234},{min:126,max:150,starter:196,professional:252},{min:151,max:200,starter:210,professional:266},{min:201,max:250,starter:234,professional:290},{min:251,max:300,starter:270,professional:336},{min:301,max:350,starter:304,professional:371},{min:351,max:400,starter:357,professional:423},{min:401,max:450,starter:392,professional:476},{min:451,max:9999,starter:427,professional:528}]};
    let plan = 'starter', cycle = 'monthly', logoSrc = "";

    function setPlan(p) { plan = p; document.querySelectorAll('[id^="p-"]').forEach(b => b.classList.remove('active')); document.getElementById('p-'+p).classList.add('active'); update(); }
    function setSub(s) { cycle = s; document.querySelectorAll('[id^="c-"]').forEach(b => b.classList.remove('active')); document.getElementById('c-'+s).classList.add('active'); update(); }
    function applyDefaultSetup() { document.getElementById('setup-fee').value = document.getElementById('region').value === 'INDIA' ? 5000 : 195; }
    
    function addRow() {
        const div = document.createElement('div'); div.className = 'dynamic-row';
        div.innerHTML = `<input type="text" placeholder="Item Name" class="row-name" oninput="update()"><div class="row-grid"><select onchange="update()" class="p-cycle"><option value="once">Once</option><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="half-yearly">6-Mon</option><option value="yearly">Yearly</option></select><input type="number" placeholder="Base Rate" class="p-price" oninput="update()"></div><div class="row-grid"><input type="number" placeholder="Disc %" class="p-disc" value="0" oninput="update()"><button onclick="this.parentElement.parentElement.remove();update()" style="color:red;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;">Delete</button></div>`;
        document.getElementById('addon-list').appendChild(div); update();
    }

    function update() {
        const region = document.getElementById('region').value, rooms = parseInt(document.getElementById('rooms').value) || 0;
        const softDisc = parseFloat(document.getElementById('soft-disc').value) || 0, setup = parseFloat(document.getElementById('setup-fee').value) || 0;
        const curr = region === 'INDIA' ? 'â‚¹' : '$';
        const getMult = (c) => ({monthly:1, quarterly:3, 'half-yearly':6, yearly:12}[c] || 1);
        
        let baseM = 0; rates[region].forEach(t => { if(rooms >= t.min && rooms <= t.max) baseM = t[plan]; });
        const coreRate = baseM * getMult(cycle), coreFinal = coreRate * (1 - (softDisc / 100));

        let rowsHtml = `<tr><td>ASI ${plan.toUpperCase()} PMS (${rooms} Rooms)</td><td>${curr}${coreRate.toLocaleString()}</td><td>${cycle.toUpperCase()}</td><td>${softDisc}%</td><td>${curr}${Math.round(coreFinal).toLocaleString()}</td></tr>`;
        if(setup > 0) rowsHtml += `<tr><td>Deployment Fee</td><td>${curr}${setup.toLocaleString()}</td><td>ONCE</td><td>0%</td><td>${curr}${setup.toLocaleString()}</td></tr>`;
        
        let total = coreFinal + setup;
        document.querySelectorAll('.dynamic-row').forEach(row => {
            const name = row.querySelector('.row-name').value || "Add-on", itemCycle = row.querySelector('.p-cycle').value, rowMonthly = parseFloat(row.querySelector('.p-price').value) || 0, disc = parseFloat(row.querySelector('.p-disc').value) || 0;
            let mult = (itemCycle === 'once') ? 1 : getMult(itemCycle);
            const itemRate = rowMonthly * mult, lineFinal = itemRate * (1 - (disc / 100));
            if(rowMonthly > 0) { total += lineFinal; rowsHtml += `<tr><td>${name}</td><td>${curr}${itemRate.toLocaleString()}</td><td>${itemCycle.toUpperCase()}</td><td>${disc}%</td><td>${curr}${Math.round(lineFinal).toLocaleString()}</td></tr>`; }
        });

        const proposalContent = `
            <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; align-items: center;">
                <div>${logoSrc ? `<img src="${logoSrc}" style="max-height:50px;">` : `<div style="font-weight:bold; font-size:20px; color:#1a2a6c;">ASI SOLUTIONS</div>`}</div>
                <h1 style="font-size: 22px; margin: 0; color: #000;">ASI Proposal</h1>
            </div>
            <div class="info-box">
                <div><span class="info-label">Property:</span> ${document.getElementById('in-hotel').value || '---'}</div>
                <div><span class="info-label">Client:</span> ${document.getElementById('in-cust').value || '---'}</div>
                <div><span class="info-label">Email:</span> ${document.getElementById('in-email').value || '---'}</div>
                <div><span class="info-label">Contact:</span> ${document.getElementById('in-phone').value || '---'}</div>
                <div><span class="info-label">Date:</span> ${document.getElementById('in-date').value || new Date().toLocaleDateString('en-GB')}</div>
                <div><span class="info-label">Sales:</span> ${document.getElementById('in-sales').value || '---'}</div>
            </div>
            <table class="line-table">
                <thead><tr><th>Description</th><th>Rate</th><th>Period</th><th>Disc %</th><th>Final Price</th></tr></thead>
                <tbody>${rowsHtml}</tbody>
            </table>
            <div style="margin-top: 25px; text-align: right;">
                <div style="font-size: 11px; font-weight: bold; color: #777;">NET PAYABLE AMOUNT</div>
                <div class="grand-total">${curr}${Math.round(total).toLocaleString()}</div>
            </div>
            <div style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 15px; font-size: 11px;">
                <strong>Terms:</strong><div style="white-space: pre-wrap; margin-top: 5px; color: #555;">${document.getElementById('in-terms').value}</div>
            </div>
        `;
        document.getElementById('proposal-preview').innerHTML = proposalContent;
        document.getElementById('proposal-capture').innerHTML = proposalContent;
    }

    function handleLogo(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { logoSrc = e.target.result; update(); }; reader.readAsDataURL(input.files[0]); } }

    async function exportProposal(type) {
        const element = document.getElementById('proposal-capture');
        const canvas = await html2canvas(element, { scale: 3, useCORS: true, logging: false });
        
        if (type === 'download') {
            const link = document.createElement('a');
            link.download = `ASI_Proposal.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        } else if (type === 'copy') {
            canvas.toBlob(async (blob) => {
                try {
                    const data = [new ClipboardItem({ "image/png": blob })];
                    await navigator.clipboard.write(data);
                    alert("Full proposal copied to clipboard!");
                } catch (err) { alert("Copy failed. Please use Download."); }
            });
        } else if (type === 'share') {
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "ASI_Proposal.png", { type: "image/png" });
                if (navigator.share) await navigator.share({ title: 'ASI Proposal', files: [file] });
                else alert("Share not supported.");
            });
        }
    }
    update();
</script>
</body>
</html>
